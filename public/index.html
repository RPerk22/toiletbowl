<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Toilet Bowl 2025</title>
<link rel="icon" href="assets/logo.jpg">
<style>
  :root{
    --bg:#121212;
    --card:#1e1e1e;
    --text:#fff;
    --primary:#f44336;
    --danger:#f44336;
    --success:#4caf50;
  }
  *{box-sizing:border-box}
  body{
    font-family:Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
    margin:0;
    padding:12px;
    line-height:1.4;
  }
  h1{
    font-size:2.4rem;
    text-align:center;
    margin:20px 0 8px;
  }
  .logo{
    width:70px;
    height:70px;
    border-radius:50%;
    border:4px solid #ffcc00;
    box-shadow:0 0 20px #ffcc00;
  }
  .connect-btn{
    background:#00d4aa;
    color:#fff;
    padding:14px 32px;
    border-radius:50px;
    font-size:1.4rem;
    font-weight:bold;
    cursor:pointer;
    display:inline-block;
    margin:15px;
  }
  .tabs{
    display:flex;
    justify-content:center;
    gap:10px;
    margin:25px 0;
    flex-wrap:wrap;
  }
  .tab{
    padding:10px 20px;
    background:var(--card);
    border-radius:50px;
    cursor:pointer;
    font-size:1.1rem;
    min-width:100px;
    text-align:center;
  }
  .tab.active{
    background:var(--primary);
    color:#fff;
  }
  .week-content{display:none}
  .week-content.active{display:block}
  .matchup{
    display:grid;
    grid-template-columns:1fr;
    gap:30px;
  }
  @media(min-width:768px){
    .matchup{grid-template-columns:1fr 1fr}
  }
  .team{
    background:var(--card);
    border:5px solid var(--danger);
    border-radius:18px;
    padding:20px;
    box-shadow:0 8px 25px rgba(255,0,0,0.4);
  }
  .team-header{
    display:flex;
    align-items:center;
    gap:15px;
    margin-bottom:15px;
    flex-wrap:wrap;
    justify-content:center;
  }
  .team-header img{width:70px;height:70px;border-radius:50%}
  .team-header h3{font-size:1.8rem;margin:0;text-align:center;flex:1}
  .score{
    font-size:4.5rem;
    text-align:center;
    margin:15px 0;
    font-weight:bold;
    color:#ff4444;
  }
  .total-score{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:20px;
    margin:30px 0;
    font-size:1.8rem;
    flex-wrap:wrap;
  }
  .total-team{
    display:flex;
    align-items:center;
    gap:12px;
    background:var(--card);
    padding:12px 20px;
    border-radius:20px;
    border:3px solid var(--danger);
  }
  .total-team img{width:50px;height:50px;border-radius:50%}
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    font-size:0.95rem;
  }
  th,td{
    padding:10px 6px;
    text-align:left;
    border-bottom:1px solid #444;
  }
  th{
    background:#333;
    font-size:0.9rem;
  }
  td img{
    width:36px;
    height:36px;
    border-radius:50%;
    vertical-align:middle;
    margin-right:8px;
  }
  /* Extra small phones */
  @media(max-width:380px){
    h1{font-size:2rem}
    .team-header h3{font-size:1.5rem}
    .score{font-size:3.8rem}
    .total-score{font-size:1.5rem;gap:15px}
    .tab{font-size:1rem;padding:8px 16px}
  }
</style>
</head>
<body>

<div style="text-align:center">
  <img src="assets/logo.jpg" class="logo" alt="Toilet Bowl Trophy">
  <h1>TOILET BOWL 2025</h1>
  <div style="font-size:4rem;margin:20px">ðŸ’©ðŸš½ðŸ§»</div>
  <div style="margin:20px 0">
    <select id="yearSelect" style="padding:10px 20px;font-size:1.2rem;border-radius:10px;background:var(--card);color:var(--text);border:2px solid var(--primary)">
      <option value="2025">2025</option>
      <option value="2024">2024</option>
      <option value="2023">2023</option>
      <option value="2022">2022</option>
      <option value="2021">2021</option>
      <option value="2020">2020</option>
      <option value="2019">2019</option>
      <option value="2018">2018</option>
      <option value="2017">2017</option>
      <option value="2016">2016</option>
      <option value="2015">2015</option>
      <option value="2014">2014</option>
      <option value="2013">2013</option>
      <option value="2012">2012</option>
      <option value="2011">2011</option>
      <option value="2010">2010</option>
    </select>
  </div>
</div>

<div id="auth" style="text-align:center;padding:60px">
  <h2>Welcome to the Loser Showdown</h2>
  <div class="connect-btn" onclick="openLoginPopup()">Connect with Yahoo</div>
  <div id="status" style="margin-top:20px"></div>
</div>

<div id="main" style="display:none;max-width:1300px;margin:auto">
  <div class="total-score" id="totalScore">
    <div class="total-team" id="totalA"></div>
    <div style="font-size:5rem;font-weight:bold">VS</div>
    <div class="total-team" id="totalB"></div>
  </div>

  <div class="tabs" id="tabsContainer">
    <!-- Tabs will be dynamically generated -->
  </div>

  <div id="weekContentContainer">
    <!-- Week content containers will be dynamically generated -->
  </div>
</div>

<script>
  const yearToLeagueKey = {
    "2010": "242.l.567621", 
    "2011": "257.l.455961", 
    "2012": "273.l.131911", 
    "2013": "314.l.506319", 
    "2014": "331.l.295948", 
    "2015": "348.l.130000", 
    "2016": "359.l.173112", 
    "2017": "371.l.535619", 
    "2018": "380.l.1003644", 
    "2019": "390.l.503579", 
    "2020": "399.l.403068", 
    "2021": "406.l.748662", 
    "2022": "414.l.501368", 
    "2023": "423.l.340798", 
    "2024": "449.l.812034", 
    "2025": "461.l.773315"
  };

  let currentYear = Object.keys(yearToLeagueKey).slice(-1)[0]; // Default to latest year
  let LEAGUE_KEY = yearToLeagueKey[currentYear];
  let isCurrentYear = true; // Track if viewing current year for auto-refresh

  let popup = null;
  let currentWeek = 15;

  function openLoginPopup() {
    popup = window.open('/login-popup', 'yahoo', 'width=520,height=680');
  }

  window.loginSuccess = () => {
    document.getElementById('auth').style.display = 'none';
    document.getElementById('main').style.display = 'block';
    loadToiletBowl();
  };

  async function yahooFetch(url) {
    const full = url.includes('?') ? `${url}&format=json` : `${url}?format=json`;
    const r = await fetch(`/api/yahoo?url=${encodeURIComponent(full)}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  function getPlayerHeadshot(playerArray) {
  // playerArray is p[0] â€” the big array of player info objects
  for (let item of playerArray) {
    if (item.headshot?.url) return item.headshot.url;
    if (item.headshot?.image_url) return item.headshot.image_url;
    if (item.image_url) return item.image_url;
  }
  // Final fallback
  return "https://s.yimg.com/lq/i/us/sp/v/nfl_cutout/players_l/default.png";
}

  function generateTabsAndContainers(finalWeek) {
    const toiletBowlWeeks = [finalWeek - 2, finalWeek - 1, finalWeek];
    
    // Clear existing tabs and containers
    const tabsContainer = document.getElementById('tabsContainer');
    const weekContentContainer = document.getElementById('weekContentContainer');
    tabsContainer.innerHTML = '';
    weekContentContainer.innerHTML = '';
    
    // Generate tabs
    toiletBowlWeeks.forEach((week, index) => {
      const tab = document.createElement('div');
      tab.className = 'tab' + (index === 0 ? ' active' : '');
      tab.setAttribute('data-week', week);
      tab.textContent = `Week ${week}`;
      tabsContainer.appendChild(tab);
      
      // Generate week content container
      const weekContent = document.createElement('div');
      weekContent.id = `week${week}`;
      weekContent.className = 'week-content' + (index === 0 ? ' active' : '');
      weekContentContainer.appendChild(weekContent);
    });
    
    // Re-attach tab click handlers
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab,.week-content').forEach(el => el.classList.remove('active'));
        tab.classList.add('active');
        const week = tab.dataset.week;
        document.getElementById('week' + week).classList.add('active');
        localStorage.setItem('toiletBowlWeek', week);
      };
    });
    
    return toiletBowlWeeks;
  }

  async function loadToiletBowl() {
    try {
      // Get current week from Yahoo
      const leagueInfo = await yahooFetch(`https://fantasysports.yahooapis.com/fantasy/v2/league/${LEAGUE_KEY}/settings`);
      const yahooCurrentWeek = parseInt(leagueInfo.fantasy_content.league[0].current_week);
      const finalWeek = parseInt(leagueInfo.fantasy_content.league[0].end_week);
      
      // Generate tabs and containers based on finalWeek
      const toiletBowlWeeks = generateTabsAndContainers(finalWeek);
      
      // Set current week to the latest available toilet bowl week
      if (toiletBowlWeeks.includes(yahooCurrentWeek)) {
        currentWeek = yahooCurrentWeek;
      } else if (yahooCurrentWeek > toiletBowlWeeks[toiletBowlWeeks.length - 1]) {
        currentWeek = toiletBowlWeeks[toiletBowlWeeks.length - 1]; // Last toilet bowl week
      } else {
        currentWeek = toiletBowlWeeks[0]; // First toilet bowl week
      }

      // Check if user previously selected a week (from localStorage)
      const savedWeek = localStorage.getItem('toiletBowlWeek');
      if (savedWeek && toiletBowlWeeks.includes(parseInt(savedWeek))) {
        currentWeek = parseInt(savedWeek);
      }

      // Activate the saved/current week
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.week-content').forEach(w => w.classList.remove('active'));
      document.querySelector(`.tab[data-week="${currentWeek}"]`).classList.add('active');
      document.getElementById(`week${currentWeek}`).classList.add('active');

      // Get standings
      const standings = await yahooFetch(`https://fantasysports.yahooapis.com/fantasy/v2/league/${LEAGUE_KEY}/standings`);
      const teamsObj = standings.fantasy_content.league[1].standings[0].teams;

      // Get # of Teams
      const numTeams = parseInt(standings.fantasy_content.league[0].num_teams);

      // TB teams indexes are last two in standings
      tb_indexA = numTeams - 2;
      tb_indexB = numTeams - 1;

      const teamList = Object.keys(teamsObj)
        .filter(k => k !== 'count')
        .map(k => teamsObj[k].team[0]);

      const loserA = { 
        name: teamList[tb_indexA][2].name, 
        key: teamList[tb_indexA][0].team_key,
        nickname: teamList[tb_indexA][23].managers?.[0]?.manager?.nickname,
        logo: teamList[tb_indexA][5].team_logos?.[0]?.team_logo?.url || "https://s.yimg.com/lq/i/us/sp/v/nfl/teams/1/50x50w/unknown.gif"
      };
      const loserB = { 
        name: teamList[tb_indexB][2].name, 
        key: teamList[tb_indexB][0].team_key,
        nickname: teamList[tb_indexB][23].managers?.[0]?.manager?.nickname,
        logo: teamList[tb_indexB][5].team_logos?.[0]?.team_logo?.url || "https://s.yimg.com/lq/i/us/sp/v/nfl/teams/1/50x50w/unknown.gif"
      };

      const totals = { A: 0, B: 0 };

      for (const week of toiletBowlWeeks) {
        const container = document.getElementById(`week${week}`);
        container.innerHTML = '<p>Loading...</p>';

        try {
          const [rosterA, playersA, rosterB, playersB] = await Promise.all([
            yahooFetch(`https://fantasysports.yahooapis.com/fantasy/v2/team/${loserA.key}/roster;week=${week}`),
            yahooFetch(`https://fantasysports.yahooapis.com/fantasy/v2/team/${loserA.key}/players/stats;type=week;week=${week}`),
            yahooFetch(`https://fantasysports.yahooapis.com/fantasy/v2/team/${loserB.key}/roster;week=${week}`),
            yahooFetch(`https://fantasysports.yahooapis.com/fantasy/v2/team/${loserB.key}/players/stats;type=week;week=${week}`)
          ]);

          // Build points map
          const buildPointsMap = (playersData) => {
            const map = {};
            const players = playersData?.fantasy_content?.team?.[1]?.players;
            if (!players) return map;
            Object.keys(players)
              .filter(k => k !== 'count')
              .forEach(k => {
                const player = players[k].player;
                const player_key = player[0][0].player_key;
                const points = parseFloat(player?.[1]?.player_points?.total || -69);
                map[player_key] = points;
              });
            return map;
          };

          const pointsMapA = buildPointsMap(playersA);
          const pointsMapB = buildPointsMap(playersB);

          // Get starters
          const getStarters = (roster) => {
            const playersObj = roster?.fantasy_content?.team?.[1]?.roster?.["0"]?.players;
            if (!playersObj) return [];
            return Object.keys(playersObj)
              .filter(k => k !== 'count')
              .map(k => playersObj[k].player)
              .filter(p => p[1].selected_position?.[1]?.position !== 'BN' && p[1].selected_position?.[1]?.position !== 'IR');
          };

          const startersA = getStarters(rosterA);
          const startersB = getStarters(rosterB);

          const pointsA = startersA.reduce((s, p) => s + (pointsMapA[p[0][0].player_key] || 0), 0);
          const pointsB = startersB.reduce((s, p) => s + (pointsMapB[p[0][0].player_key] || 0), 0);

          totals.A += pointsA;
          totals.B += pointsB;

          // Update running total
          document.getElementById('totalA').innerHTML = `
            <img src="${loserA.logo}" width="60" height="60">
            <div><div style="font-size:2rem">${loserA.nickname}</div><div style="font-size:3rem;color:#ff6666">${totals.A.toFixed(2)}</div></div>`;
          document.getElementById('totalB').innerHTML = `
            <img src="${loserB.logo}" width="60" height="60">
            <div><div style="font-size:2rem">${loserB.nickname}</div><div style="font-size:3rem;color:#ff6666">${totals.B.toFixed(2)}</div></div>`;

          let html = '<div class="matchup">';

          // TEAM A
          html += `
            <div class="team">
              <div class="team-header">
                <img src="${loserA.logo}" width="80" height="80">
                <h3>${loserA.name}</h3>
              </div>
              <div class="score">${pointsA.toFixed(2)}</div>
              <table><thead><tr><th></th><th>Player</th><th>Pos</th><th>Pts</th></tr></thead><tbody>`;

          startersA.forEach(p => {
            const playerKey = p[0][0].player_key;
            const name = p[0][2].name?.full || '??';
            const headshot = getPlayerHeadshot(p[0]);
            const pos = p[1].selected_position[1].position;
            const pts = (pointsMapA[playerKey] || 0).toFixed(1);

            html += `
              <tr>
                <td><img src="${headshot}" width="40" height="40"></td>
                <td>${name}</td>
                <td>${pos}</td>
                <td><strong>${pts}</strong></td>
              </tr>`;
          });
          html += `</tbody></table></div>`;

          // TEAM B
          html += `
            <div class="team">
              <div class="team-header">
                <img src="${loserB.logo}" width="80" height="80">
                <h3>${loserB.name}</h3>
              </div>
              <div class="score">${pointsB.toFixed(2)}</div>
              <table><thead><tr><th></th><th>Player</th><th>Pos</th><th>Pts</th></tr></thead><tbody>`;

          startersB.forEach(p => {
            const playerKey = p[0][0].player_key;
            const name = p[0][2].name?.full || '??';
            const headshot = getPlayerHeadshot(p[0]);
            const pos = p[1].selected_position[1].position;
            const pts = (pointsMapB[playerKey] || 0).toFixed(1);

            html += `
              <tr>
                <td><img src="${headshot}" width="40" height="40"></td>
                <td>${name}</td>
                <td>${pos}</td>
                <td><strong>${pts}</strong></td>
              </tr>`;
          });
          html += `</tbody></table></div>`;

          container.innerHTML = html;
        } catch (e) {
          container.innerHTML = `<p>Week ${week}: No data yet</p>`;
        }
      }

    } catch (err) {
      console.error("Error:", err);
      document.getElementById('status').innerHTML = 'Error: ' + err.message;
    }
  }

  // Tab switching â€” saves to localStorage
  document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      document.querySelectorAll('.tab,.week-content').forEach(el => el.classList.remove('active'));
      tab.classList.add('active');
      const week = tab.dataset.week;
      document.getElementById('week' + week).classList.add('active');
      localStorage.setItem('toiletBowlWeek', week); // â† REMEMBER USER CHOICE
    };
  });

  async function init() {
    try {
      await yahooFetch(`https://fantasysports.yahooapis.com/fantasy/v2/league/${LEAGUE_KEY}/settings`);
      loginSuccess();
    } catch (e) {}
  }
  init();
  setInterval(() => {
    if (document.getElementById('main').style.display !== 'none' && isCurrentYear) {
      loadToiletBowl();
    }
  }, 45000);

  // Year selection handler
  document.getElementById('yearSelect').addEventListener('change', function() {
    currentYear = this.value;
    LEAGUE_KEY = yearToLeagueKey[currentYear];
    isCurrentYear = currentYear === "2025"; // Only auto-refresh for current year
    // Update the title
    document.querySelector('h1').textContent = `TOILET BOWL ${currentYear}`;
    // Clear saved week since weeks change by year
    localStorage.removeItem('toiletBowlWeek');
    // Reload data if user is logged in
    if (document.getElementById('main').style.display !== 'none') {
      loadToiletBowl();
    }
  });

  // Set initial year in dropdown
  document.getElementById('yearSelect').value = currentYear;
</script>
</body>
</html>
